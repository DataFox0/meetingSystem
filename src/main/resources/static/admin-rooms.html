<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Rooms - Admin Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/admin-styles.css">
    <style>
        /* 自定义设施样式 */
        .facilities-container {
            margin-top: 10px;
        }
        
        .facilities-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .checkbox-item label {
            margin-left: 5px;
            cursor: pointer;
        }
        
        .custom-facility-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .custom-facility-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .custom-facility-input button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .custom-facility-input button:hover {
            background-color: #45a049;
        }
        
        .custom-facilities {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .custom-facility-tag {
            display: flex;
            align-items: center;
            background-color: #e9f7ef;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #c8e6d2;
        }
        
        .remove-facility {
            margin-left: 5px;
            color: #e74c3c;
            cursor: pointer;
            font-weight: bold;
        }
        
        .remove-facility:hover {
            color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Room Management</h1>
            <nav>
                <ul>
                    <li><a href="admin-dashboard.html">Dashboard</a></li>
                    <li><a href="admin-rooms.html" class="active">Rooms</a></li>
                    <li><a href="admin-reservations.html">Reservations</a></li>
                    <li><a href="admin-users.html">Users</a></li>
                    <li><a href="#" id="logoutBtn">Logout</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <section class="admin-header">
                <h2>Manage Meeting Rooms</h2>
                <button id="createRoomBtn" class="btn">Create New Room</button>
            </section>
            
            <section class="admin-content">
                <div class="admin-table-container">
                    <table id="roomsTable" class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Location</th>
                                <th>Capacity</th>
                                <th>Facilities</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 会议室数据将在这里动态生成 -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- 创建/编辑会议室的模态框 -->
            <div id="roomModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2 id="roomModalTitle">Create New Room</h2>
                    <form id="roomForm">
                        <input type="hidden" id="roomId">
                        
                        <div class="form-group">
                            <label for="name">Room Name</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="location">Location</label>
                            <input type="text" id="location" name="location" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="capacity">Capacity</label>
                            <input type="number" id="capacity" name="capacity" min="1" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="imageUrl">Image URL</label>
                            <input type="text" id="imageUrl" name="imageUrl">
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Facilities</label>
                            <div class="facilities-container">
                            <div class="facilities-checkboxes" id="facilitiesContainer">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="facility-projector" name="facilities" value="Projector">
                                    <label for="facility-projector">Projector</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="facility-whiteboard" name="facilities" value="Whiteboard">
                                    <label for="facility-whiteboard">Whiteboard</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="facility-wifi" name="facilities" value="WiFi">
                                    <label for="facility-wifi">WiFi</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="facility-audio" name="facilities" value="Speaker System">
                                    <label for="facility-audio">Speaker System</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="facility-video" name="facilities" value="Video Conferencing Equipment">
                                    <label for="facility-video">Video Conferencing Equipment</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="facility-stage" name="facilities" value="Stage">
                                    <label for="facility-stage">Stage</label>
                                    </div>
                                </div>
                                
                                <!-- 自定义设施区域 -->
                                <div class="custom-facility-input">
                                    <input type="text" id="newFacility" placeholder="Add Facility">
                                    <button type="button" id="addFacilityBtn">Add Facility</button>
                                </div>
                                
                                <div class="custom-facilities" id="customFacilitiesContainer">
                                    <!-- 自定义设施将在这里动态生成 -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save Room</button>
                            <button type="button" class="btn btn-secondary close-btn">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- 确认删除模态框 -->
            <div id="deleteConfirmModal" class="modal">
                <div class="modal-content">
                    <h2>Confirm Deletion</h2>
                    <p>Are you sure you want to delete this room?</p>
                    <p>This action cannot be undone. Any reservations for this room will be cancelled.</p>
                    <div class="modal-actions">
                        <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
                        <button class="btn btn-secondary close-btn">Cancel</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 Meeting Reservation System</p>
        </footer>
    </div>

    <script src="js/api.js"></script>
    <script src="js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否是管理员
            if (!isAdmin()) {
                window.location.href = 'login.html';
                return;
            }
            
            // 绑定登出按钮事件
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                localStorage.removeItem('role');
                window.location.href = 'login.html';
            });
            
            // 加载会议室列表
            loadRooms();
            
            // 设置创建会议室按钮点击事件
            document.getElementById('createRoomBtn').addEventListener('click', showCreateRoomModal);
            
            // 设置模态框关闭事件
            document.querySelectorAll('.close, .close-btn').forEach(element => {
                element.addEventListener('click', function() {
                    document.getElementById('roomModal').style.display = 'none';
                    document.getElementById('deleteConfirmModal').style.display = 'none';
                });
            });
            
            // 设置表单提交事件
            document.getElementById('roomForm').addEventListener('submit', handleRoomSubmit);
            
            // 设置添加自定义设施事件
            document.getElementById('addFacilityBtn').addEventListener('click', addCustomFacility);
            
            // 按回车键添加设施
            document.getElementById('newFacility').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    addCustomFacility();
                }
            });
            
            // 点击页面其他地方关闭模态框
            window.addEventListener('click', function(event) {
                if (event.target.className === 'modal') {
                    event.target.style.display = 'none';
                }
            });
        });

        // 检查是否是管理员
        function isAdmin() {
            const token = localStorage.getItem('token');
            const role = localStorage.getItem('role');
            return token && (role === 'ADMIN' || true); // 临时允许所有身份
        }

        // 添加自定义设施
        function addCustomFacility() {
            const facilityInput = document.getElementById('newFacility');
            const facilityText = facilityInput.value.trim();
            
            if (!facilityText) return; // 空值不处理
            
            // 检查是否已存在该设施
            const existingFacilities = getAllSelectedFacilities();
            if (existingFacilities.includes(facilityText)) {
                alert('This facility has been added');
                return;
            }
            
            // 创建自定义设施标签
            const customContainer = document.getElementById('customFacilitiesContainer');
            const facilityTag = document.createElement('div');
            facilityTag.className = 'custom-facility-tag';
            facilityTag.innerHTML = `
                <input type="hidden" name="custom-facilities" value="${facilityText}">
                ${facilityText}
                <span class="remove-facility" title="Remove">&times;</span>
            `;
            
            // 添加移除设施的事件
            facilityTag.querySelector('.remove-facility').addEventListener('click', function() {
                facilityTag.remove();
            });
            
            customContainer.appendChild(facilityTag);
            facilityInput.value = ''; // 清空输入框
        }

        // 获取所有选中的设施（包括标准设施和自定义设施）
        function getAllSelectedFacilities() {
            const standardFacilities = Array.from(document.querySelectorAll('input[name="facilities"]:checked'))
                .map(checkbox => checkbox.value);
                
            const customFacilities = Array.from(document.querySelectorAll('input[name="custom-facilities"]'))
                .map(input => input.value);
                
            return [...standardFacilities, ...customFacilities];
        }

        // 加载会议室列表
        function loadRooms() {
            console.log('Loading rooms...');
            
            // 显示loading状态
            const tableBody = document.querySelector('#roomsTable tbody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading rooms...</td></tr>';
            
            const token = localStorage.getItem('token');
            
            fetch('/api/admin/rooms', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load rooms');
                }
                return response.json();
            })
            .then(rooms => {
                console.log('Rooms loaded:', rooms);
                
                tableBody.innerHTML = '';
                
                if (!rooms || rooms.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No rooms found</td></tr>';
                    return;
                }
                
                rooms.forEach(room => {
                    const tr = document.createElement('tr');
                    
                    tr.innerHTML = `
                        <td>${room.id}</td>
                        <td>${room.name || '-'}</td>
                        <td>${room.location || '-'}</td>
                        <td>${room.capacity || '-'}</td>
                        <td>${formatFacilities(room.facilities)}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-primary edit-btn" data-id="${room.id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${room.id}">Delete</button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(tr);
                });
                
                // 添加编辑和删除按钮事件
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const roomId = this.getAttribute('data-id');
                        showEditRoomModal(roomId, rooms);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const roomId = this.getAttribute('data-id');
                        showDeleteConfirmation(roomId);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading rooms:', error);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Error loading rooms: ${error.message}</td></tr>`;
            });
        }

        // 格式化设施列表
        function formatFacilities(facilities) {
            if (!facilities || facilities.length === 0) {
                return '<em>None</em>';
            }
            
            return facilities.map(facility => 
                `<span class="facility-tag">${facility}</span>`
            ).join(' ');
        }

        // 显示创建会议室模态框
        function showCreateRoomModal() {
            // 重置表单
            document.getElementById('roomForm').reset();
            document.getElementById('roomId').value = '';
            document.getElementById('customFacilitiesContainer').innerHTML = '';
            
            // 设置标题
            document.getElementById('roomModalTitle').textContent = 'Create New Room';
            
            // 显示模态框
            document.getElementById('roomModal').style.display = 'block';
        }

        // 显示编辑会议室模态框
        function showEditRoomModal(roomId, rooms) {
            // 查找会议室
            const room = rooms.find(r => r.id == roomId);
            
            if (!room) {
                alert('Room not found');
                return;
            }
            
            // 设置表单值
            document.getElementById('roomId').value = room.id;
            document.getElementById('name').value = room.name || '';
            document.getElementById('location').value = room.location || '';
            document.getElementById('capacity').value = room.capacity || '';
            document.getElementById('imageUrl').value = room.imageUrl || '';
            document.getElementById('description').value = room.description || '';
            
            // 清空自定义设施容器
            document.getElementById('customFacilitiesContainer').innerHTML = '';
            
            // 设置设施复选框
            const standardFacilities = ['Projector', 'Whiteboard', 'WiFi', 'Speaker System', 'Video Conferencing Equipment', 'Stage'];
            const customFacilities = room.facilities.filter(f => !standardFacilities.includes(f));
            
            // 重置所有复选框
            document.querySelectorAll('input[name="facilities"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // 设置标准设施
            document.querySelectorAll('input[name="facilities"]').forEach(checkbox => {
                checkbox.checked = room.facilities && room.facilities.includes(checkbox.value);
            });
            
            // 添加自定义设施
            const customContainer = document.getElementById('customFacilitiesContainer');
            customFacilities.forEach(facility => {
                const facilityTag = document.createElement('div');
                facilityTag.className = 'custom-facility-tag';
                facilityTag.innerHTML = `
                    <input type="hidden" name="custom-facilities" value="${facility}">
                    ${facility}
                    <span class="remove-facility" title="remove">&times;</span>
                `;
                
                // 添加移除设施的事件
                facilityTag.querySelector('.remove-facility').addEventListener('click', function() {
                    facilityTag.remove();
                });
                
                customContainer.appendChild(facilityTag);
            });
            
            // 设置标题
            document.getElementById('roomModalTitle').textContent = 'Edit Room';
            
            // 显示模态框
            document.getElementById('roomModal').style.display = 'block';
        }

        // 处理会议室表单提交
        function handleRoomSubmit(event) {
            event.preventDefault();
            
            const roomId = document.getElementById('roomId').value;
            const isEdit = !!roomId;
            
            // 显示处理中状态
            const submitBtn = document.querySelector('#roomForm button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Processing...';
            submitBtn.disabled = true;
            
            // 收集表单数据
            const roomData = {
                name: document.getElementById('name').value,
                location: document.getElementById('location').value,
                capacity: parseInt(document.getElementById('capacity').value),
                imageUrl: document.getElementById('imageUrl').value,
                description: document.getElementById('description').value,
                facilities: getAllSelectedFacilities()
            };
            
            console.log('Room data to submit:', roomData);
            const token = localStorage.getItem('token');
            
            // 创建或更新会议室
            const url = isEdit ? `/api/admin/rooms/${roomId}` : '/api/admin/rooms';
            const method = isEdit ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(roomData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to save room');
                }
                return response.json();
            })
            .then(response => {
                console.log(`Room ${isEdit ? 'updated' : 'created'} successfully:`, response);
                alert(`Room ${isEdit ? 'updated' : 'created'} successfully`);
                document.getElementById('roomModal').style.display = 'none';
                loadRooms(); // 重新加载会议室列表
            })
            .catch(error => {
                console.error(`Error ${isEdit ? 'updating' : 'creating'} room:`, error);
                alert(`Failed to ${isEdit ? 'update' : 'create'} room: ` + error.message);
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        }

        // 显示删除确认框
        function showDeleteConfirmation(roomId) {
            // 保存要删除的会议室ID
            document.getElementById('confirmDeleteBtn').setAttribute('data-id', roomId);
            
            // 显示确认模态框
            document.getElementById('deleteConfirmModal').style.display = 'block';
            
            // 设置确认按钮点击事件
            document.getElementById('confirmDeleteBtn').onclick = function() {
                const id = this.getAttribute('data-id');
                deleteRoom(id);
            };
        }

        // 删除会议室
        function deleteRoom(roomId) {
            // 显示加载状态
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const originalText = confirmBtn.textContent;
            confirmBtn.textContent = 'Deleting...';
            confirmBtn.disabled = true;
            
            const token = localStorage.getItem('token');
            
            fetch(`/api/admin/rooms/${roomId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete room');
                }
                
                alert('Room deleted successfully');
                document.getElementById('deleteConfirmModal').style.display = 'none';
                loadRooms(); // 重新加载会议室列表
            })
            .catch(error => {
                console.error('Error deleting room:', error);
                alert('Failed to delete room: ' + error.message);
            })
            .finally(() => {
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
            });
        }
    </script>
</body>
</html> 